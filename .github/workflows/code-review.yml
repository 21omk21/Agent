name: AI Code Review

on:
  pull_request:
    types: [opened, synchronize, reopened]

permissions:
  contents: read
  pull-requests: write

jobs:
  code-review:
    runs-on: ubuntu-latest
    name: AI Code Review Agent
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Get changed files
        id: changed-files
        uses: tj-actions/changed-files@v44
        with:
          files: |
            **/*.js
            **/*.ts
            **/*.jsx
            **/*.tsx
            **/*.py
            **/*.java
            **/*.go
            **/*.rs
            **/*.cpp
            **/*.c
            **/*.cs

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Run Code Review Agent
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          cat << 'EOF' > review-code.js
          const fs = require('fs');
          
          const CODE_REVIEW_ENDPOINT = 'https://izkk7wbbc3fzdc63kkzhfm7h6u0ldzgx.lambda-url.us-east-1.on.aws/';
          const changedFiles = process.env.CHANGED_FILES ? process.env.CHANGED_FILES.split(' ').filter(f => f.trim()) : [];

          async function reviewCode(codeText, fileName) {
            try {
              const response = await fetch(CODE_REVIEW_ENDPOINT, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ code_text: codeText }),
              });
              if (!response.ok) throw new Error('HTTP error: ' + response.status);
              const data = await response.json();
              return data.review || 'No review generated';
            } catch (error) {
              console.error('Error reviewing ' + fileName + ':', error.message);
              return null;
            }
          }

          async function main() {
            if (changedFiles.length === 0) {
              console.log('No code files changed.');
              fs.writeFileSync('review-output.md', '# AI Code Review\n\nNo code files changed.');
              return;
            }
            
            let reviews = ['# ðŸ¤– AI Code Review Report\n', '**Files Analyzed:** ' + changedFiles.length + '\n', '---\n'];
            
            for (const file of changedFiles) {
              if (!fs.existsSync(file)) continue;
              console.log('Reviewing: ' + file);
              const content = fs.readFileSync(file, 'utf-8');
              if (content.length === 0 || content.length > 100000) continue;
              
              const review = await reviewCode(content, file);
              if (review) {
                reviews.push('## ðŸ“„ ' + file + '\n\n' + review + '\n\n---\n');
              }
              await new Promise(r => setTimeout(r, 2000));
            }
            
            reviews.push('\n*Generated by AI Code Review Agent*');
            fs.writeFileSync('review-output.md', reviews.join('\n'));
            console.log('Review completed!');
          }

          main().catch(console.error);
          EOF
          
          CHANGED_FILES="${{ steps.changed-files.outputs.all_changed_files }}" node review-code.js

      - name: Post review comment
        if: always()
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const fs = require('fs');
            let review = 'No review output.';
            if (fs.existsSync('review-output.md')) {
              review = fs.readFileSync('review-output.md', 'utf-8');
            }
            
            const { data: comments } = await github.rest.issues.listComments({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number
            });
            
            const botComment = comments.find(c => c.user.type === 'Bot' && c.body.includes('AI Code Review'));
            
            if (botComment) {
              await github.rest.issues.updateComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                comment_id: botComment.id,
                body: review.substring(0, 65000)
              });
            } else {
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: context.issue.number,
                body: review.substring(0, 65000)
              });
            }
